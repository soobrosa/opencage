<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POI Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 1em; }
    h1 { font-size: 1.5em; }
    .container { display: flex; gap: 1em; flex-wrap: wrap; }
    #map { height: 400px; width: 100%; min-width: 300px; flex: 1; border: 1px solid #ccc; border-radius: 8px; }
    #sidebar { flex: 1; min-width: 300px; }
    #pois { margin-top: 1em; max-height: 350px; overflow-y: auto; }
    .poi { margin-bottom: 1em; padding: 0.5em; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .poi:hover { background-color: #f5f5f5; }
    .poi.highlighted { background-color: #e3f2fd; border-color: #2196f3; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3); }
    button { margin-top: 0.5em; }
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      #map { height: 300px; }
    }
  </style>
</head>
<body>

<h1>Nearby POI Check-In</h1>
<p id="status">Getting your location...</p>
<p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">üí° Click venues in the list to view on map, or click map markers to highlight in list</p>

<div id="github-setup" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 6px; margin-bottom: 1em; font-size: 0.9em;">
  <strong>üîê Secure GitHub Storage Setup:</strong> 
  <span id="github-status">Check-ins are saved locally. To sync with GitHub:</span>
  
  <details style="margin-top: 8px;">
    <summary style="cursor: pointer; font-weight: bold;">üìã Setup Options (Click to expand)</summary>
    
    <div style="margin-top: 8px;">
      <strong>Option 1: Local Development (Secure)</strong>
      <ol style="margin: 4px 0 0 20px; padding: 0;">
        <li>Create a <a href="https://github.com/settings/tokens" target="_blank">GitHub Personal Access Token</a> with "repo" permissions</li>
        <li>Copy <code>config.example.js</code> to <code>config.js</code></li>
        <li>Add your token to <code>config.js</code> (this file is gitignored and won't be committed)</li>
      </ol>
      
      <strong>Option 2: Vercel Deployment (Production)</strong>
      <ol style="margin: 4px 0 0 20px; padding: 0;">
        <li>In Vercel dashboard, go to your project settings</li>
        <li>Add Environment Variable: <code>GITHUB_TOKEN</code> = your token</li>
        <li>Redeploy your app - the token will be injected securely at build time</li>
      </ol>
      
      <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #666;">
        üí° <strong>Security:</strong> Never commit tokens to git! Use config.js locally and environment variables in production.
      </p>
    </div>
  </details>
</div>

<div class="container">
  <div id="map"></div>
  <div id="sidebar">
    <div id="pois"></div>
    <div id="history" style="margin-top: 1em; padding-top: 1em; border-top: 1px solid #ddd;"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js" onerror="console.log('config.js not found - using default config')"></script>
<script>
let map;
let userMarker;
let poiMarkers = [];
let userLocation = { lat: null, lon: null };
let currentHighlightedPoi = null;
let initialMapView = { lat: null, lon: null, zoom: 16 };
let checkInHistory = [];

// GitHub API configuration will be loaded from config.js
let GITHUB_CONFIG = {
  owner: 'soobrosa',
  repo: 'opencage',
  path: 'checkins.json',
  token: '',
  apiUrl: 'https://api.github.com'
};

// Calculate distance between two points using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth's radius in kilometers
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c; // Distance in kilometers
  return Math.round(distance * 1000); // Return distance in meters
}

// Function to highlight a POI in the list and scroll to it
function highlightPOIInList(poiId) {
  // Remove previous highlight
  if (currentHighlightedPoi) {
    currentHighlightedPoi.classList.remove('highlighted');
  }
  
  // Find and highlight the new POI
  const poiElement = document.getElementById(`poi-${poiId}`);
  if (poiElement) {
    poiElement.classList.add('highlighted');
    currentHighlightedPoi = poiElement;
    
    // Scroll POI into view
    poiElement.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center' 
    });
  }
}

// GitHub API functions for storing check-ins
async function loadCheckInHistory() {
  if (!GITHUB_CONFIG.token) {
    console.log('No GitHub token provided - using local storage fallback');
    const stored = localStorage.getItem('poi-checkins');
    checkInHistory = stored ? JSON.parse(stored) : [];
    return;
  }

  try {
    const response = await fetch(`${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      const content = atob(data.content.replace(/\s/g, ''));
      checkInHistory = JSON.parse(content);
    } else if (response.status === 404) {
      // File doesn't exist yet, start with empty array
      checkInHistory = [];
    }
  } catch (error) {
    console.log('Failed to load check-in history from GitHub:', error);
    // Fallback to local storage
    const stored = localStorage.getItem('poi-checkins');
    checkInHistory = stored ? JSON.parse(stored) : [];
  }
}

async function saveCheckInHistory() {
  // Always save to local storage as backup
  localStorage.setItem('poi-checkins', JSON.stringify(checkInHistory));

  if (!GITHUB_CONFIG.token) {
    console.log('No GitHub token - saved to local storage only');
    return;
  }

  try {
    // First, get the current file SHA if it exists
    let sha = null;
    try {
      const response = await fetch(`${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      if (response.ok) {
        const data = await response.json();
        sha = data.sha;
      }
    } catch (e) {
      // File might not exist, which is fine
    }

    // Create or update the file
    const content = btoa(JSON.stringify(checkInHistory, null, 2));
    const body = {
      message: `Update check-ins: ${new Date().toISOString()}`,
      content: content
    };
    
    if (sha) {
      body.sha = sha;
    }

    const response = await fetch(`${GITHUB_CONFIG.apiUrl}/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      throw new Error(`GitHub API error: ${response.status}`);
    }
    
    console.log('Check-in history saved to GitHub successfully');
  } catch (error) {
    console.error('Failed to save to GitHub:', error);
    // Data is still saved locally as fallback
  }
}

async function addCheckIn(poi, name, type) {
  const checkIn = {
    id: Date.now().toString(),
    name: name,
    type: type,
    coordinates: {
      lat: poi.lat || poi.center?.lat,
      lon: poi.lon || poi.center?.lon
    },
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString()
  };

  checkInHistory.unshift(checkIn); // Add to beginning of array
  await saveCheckInHistory();
  updateCheckInDisplay();
  
  return checkIn;
}

function getCheckInCount(name) {
  return checkInHistory.filter(checkIn => checkIn.name === name).length;
}

function updateCheckInDisplay() {
  // Update any existing POI displays to show check-in counts
  document.querySelectorAll('.poi').forEach((div, index) => {
    const nameElement = div.querySelector('strong');
    if (nameElement) {
      const name = nameElement.textContent;
      const count = getCheckInCount(name);
      if (count > 0) {
        // Add check-in badge if not already present
        if (!div.querySelector('.checkin-badge')) {
          const badge = document.createElement('span');
          badge.className = 'checkin-badge';
          badge.style.cssText = 'background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 8px;';
          badge.textContent = `‚úì ${count}`;
          nameElement.appendChild(badge);
        } else {
          // Update existing badge
          div.querySelector('.checkin-badge').textContent = `‚úì ${count}`;
        }
      }
    }
  });
  
  // Update history display
  updateHistoryDisplay();
}

function showNotification(message) {
  // Create notification element
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    opacity: 0;
    transition: opacity 0.3s;
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Fade in
  setTimeout(() => notification.style.opacity = '1', 100);
  
  // Remove after 3 seconds
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => document.body.removeChild(notification), 300);
  }, 3000);
}

function updateHistoryDisplay() {
  const historyContainer = document.getElementById('history');
  if (!historyContainer) return;
  
  if (checkInHistory.length === 0) {
    historyContainer.innerHTML = '<p style="color: #666; font-style: italic;">No check-ins yet. Start exploring!</p>';
    return;
  }
  
  const recentCheckins = checkInHistory.slice(0, 5); // Show last 5
  historyContainer.innerHTML = `
    <h3 style="margin: 0 0 10px 0; font-size: 1.1em;">Recent Check-ins</h3>
    ${recentCheckins.map(checkIn => `
      <div style="margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 0.9em;">
        <strong>${checkIn.name}</strong><br>
        <small style="color: #666;">${checkIn.type} ‚Ä¢ ${checkIn.date} ${checkIn.time}</small>
      </div>
    `).join('')}
    ${checkInHistory.length > 5 ? `<small style="color: #666;">... and ${checkInHistory.length - 5} more</small>` : ''}
  `;
}

function initMap(lat, lon) {
  // Store user location for distance calculations
  userLocation.lat = lat;
  userLocation.lon = lon;
  
  // Store initial map view for reset functionality
  initialMapView.lat = lat;
  initialMapView.lon = lon;
  initialMapView.zoom = 16;
  
  map = L.map('map').setView([lat, lon], 16);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);
  
  // Add custom reset control
  const resetControl = L.Control.extend({
    options: {
      position: 'topleft'
    },
    
    onAdd: function(map) {
      const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
      
      container.style.backgroundColor = 'white';
      container.style.backgroundImage = 'none';
      container.style.width = '30px';
      container.style.height = '30px';
      container.style.cursor = 'pointer';
      container.innerHTML = 'üè†';
      container.style.fontSize = '18px';
      container.style.lineHeight = '30px';
      container.style.textAlign = 'center';
      container.title = 'Reset view to your location';
      
      container.onclick = function() {
        map.setView([initialMapView.lat, initialMapView.lon], initialMapView.zoom);
        userMarker.openPopup();
        
        // Clear any highlighted POI
        if (currentHighlightedPoi) {
          currentHighlightedPoi.classList.remove('highlighted');
          currentHighlightedPoi = null;
        }
      };
      
      return container;
    }
  });
  
  map.addControl(new resetControl());
  
  // Add user location marker
  userMarker = L.marker([lat, lon], {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  
  userMarker.bindPopup("üìç Your Location").openPopup();
}

function addPOIToMap(poi, name, type, poiId) {
  const lat = poi.lat || poi.center?.lat;
  const lon = poi.lon || poi.center?.lon;
  
  if (!lat || !lon) return null;
  
  const marker = L.marker([lat, lon], {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  
  marker.bindPopup(`<strong>${name}</strong><br><em>${type}</em>`);
  
  // Add click handler to marker to highlight corresponding POI in list
  marker.on('click', function() {
    highlightPOIInList(poiId);
  });
  
  poiMarkers.push(marker);
  
  return marker; // Return marker so we can reference it later
}

async function fetchPOIs(lat, lon) {
  const radius = 500; // meters
  const query = `
    [out:json];
    (
      node(around:${radius},${lat},${lon})["amenity"];
      way(around:${radius},${lat},${lon})["amenity"];
      relation(around:${radius},${lat},${lon})["amenity"];
    );
    out center;
  `;

  const response = await fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query,
  });

  const data = await response.json();
  return data.elements;
}

function displayPOIs(pois) {
  const container = document.getElementById("pois");
  container.innerHTML = "";

  // Clear existing POI markers
  poiMarkers.forEach(marker => map.removeLayer(marker));
  poiMarkers = [];
  
  // Clear any existing highlight
  currentHighlightedPoi = null;

  if (pois.length === 0) {
    container.textContent = "No POIs found within 500m.";
    return;
  }

  const filteredPois = [];

  pois.forEach((poi, i) => {
    // Try multiple name sources from OpenStreetMap tags
    const name = poi.tags.name || 
                 poi.tags.brand || 
                 poi.tags.operator || 
                 poi.tags['addr:housename'] || 
                 poi.tags.official_name || 
                 poi.tags.alt_name ||
                 poi.tags.ref ||
                 null; // Don't fall back to amenity type
    
    // Only show POIs with proper names that start with a capital letter
    if (!name || !name.charAt(0).match(/[A-Z]/)) {
      return;
    }

    // Calculate distance from user location
    const poiLat = poi.lat || poi.center?.lat;
    const poiLon = poi.lon || poi.center?.lon;
    
    if (!poiLat || !poiLon) return;

    const distance = calculateDistance(userLocation.lat, userLocation.lon, poiLat, poiLon);
    
    filteredPois.push({
      ...poi,
      name: name,
      distance: distance
    });
  });

  // Sort POIs by distance (closest first)
  filteredPois.sort((a, b) => a.distance - b.distance);

  // Display sorted POIs
  filteredPois.forEach((poi, i) => {
    const type = poi.tags.amenity || "Unknown";
    const div = document.createElement("div");
    div.className = "poi";
    div.id = `poi-${i}`; // Add unique ID for each POI
    
    // Format distance display
    const distanceText = poi.distance < 1000 ? 
      `${poi.distance}m` : 
      `${(poi.distance / 1000).toFixed(1)}km`;
    
    div.innerHTML = `<strong>${poi.name}</strong><br><em>${type}</em><br><small>üìç ${distanceText} away ‚Ä¢ Click to view on map</small><br>`;
    
    const btn = document.createElement("button");
    btn.textContent = "Check In";
    btn.onclick = async (e) => {
      e.stopPropagation(); // Prevent div click when button is clicked
      
      // Show loading state
      btn.textContent = "Checking in...";
      btn.disabled = true;
      
      try {
        const checkIn = await addCheckIn(poi, poi.name, type);
        btn.textContent = "‚úì Checked In!";
        btn.style.backgroundColor = "#4CAF50";
        btn.style.color = "white";
        
        // Reset button after 2 seconds
        setTimeout(() => {
          btn.textContent = "Check In";
          btn.disabled = false;
          btn.style.backgroundColor = "";
          btn.style.color = "";
        }, 2000);
        
        // Show success message
        showNotification(`‚úÖ Checked in to ${poi.name}!`);
        
      } catch (error) {
        console.error('Check-in failed:', error);
        btn.textContent = "Check In";
        btn.disabled = false;
        showNotification(`‚ùå Check-in failed. Saved locally.`);
      }
    };
    div.appendChild(btn);

    container.appendChild(div);

    // Add POI to map and get marker reference (pass POI ID)
    const marker = addPOIToMap(poi, poi.name, type, i);
    
    // Add click handler to POI div to zoom to location on map
    if (marker) {
      div.onclick = (e) => {
        // Don't trigger if button was clicked
        if (e.target.tagName === 'BUTTON') return;
        
        // Remove any existing highlight first
        if (currentHighlightedPoi) {
          currentHighlightedPoi.classList.remove('highlighted');
        }
        
        // Highlight this POI
        div.classList.add('highlighted');
        currentHighlightedPoi = div;
        
        const poiLat = poi.lat || poi.center?.lat;
        const poiLon = poi.lon || poi.center?.lon;
        
        if (poiLat && poiLon) {
          // Zoom to POI location
          map.setView([poiLat, poiLon], 18);
          // Open the marker popup
          marker.openPopup();
        }
      };
    }
  });

  // Update status with filtered count
  const statusElement = document.getElementById("status");
  const originalText = statusElement.textContent;
  statusElement.textContent = originalText.replace(/Found \d+ POIs:/, `Found ${filteredPois.length} named POIs (${pois.length} total):`);
  
  // Update check-in display after POIs are loaded
  setTimeout(updateCheckInDisplay, 100);
}

function showError(error) {
  document.getElementById("status").textContent = "Error: " + error.message;
}

function loadConfig() {
  // Priority order: external config.js > environment variables > defaults
  
  // 1. Try to load from external config.js file
  if (window.GITHUB_CONFIG) {
    GITHUB_CONFIG = { ...GITHUB_CONFIG, ...window.GITHUB_CONFIG };
    console.log('‚úÖ Loaded config from config.js');
    return;
  }
  
  // 2. Try to load from Vercel environment variables (injected at build time)
  if (typeof process !== 'undefined' && process.env) {
    if (process.env.GITHUB_TOKEN) {
      GITHUB_CONFIG.token = process.env.GITHUB_TOKEN;
      console.log('‚úÖ Loaded GitHub token from environment variable');
      return;
    }
  }
  
  // 3. Try to load from global variables (set by Vercel at build time)
  if (typeof VITE_GITHUB_TOKEN !== 'undefined') {
    GITHUB_CONFIG.token = VITE_GITHUB_TOKEN;
    console.log('‚úÖ Loaded GitHub token from Vite environment');
    return;
  }
  
  console.log('üìù Using default config - add config.js or set GITHUB_TOKEN environment variable');
}

function updateGitHubStatus() {
  const statusElement = document.getElementById('github-status');
  if (GITHUB_CONFIG.token) {
    statusElement.textContent = '‚úÖ GitHub sync enabled - check-ins will be saved to your repository!';
    statusElement.style.color = '#28a745';
    document.getElementById('github-setup').style.background = '#d4edda';
    document.getElementById('github-setup').style.borderColor = '#c3e6cb';
  } else {
    statusElement.textContent = 'Check-ins are saved locally. To sync with GitHub:';
  }
}

// Initialize app
async function initApp() {
  // Load config from external file or environment variables
  loadConfig();
  
  // Update GitHub status
  updateGitHubStatus();
  
  // Load check-in history first
  await loadCheckInHistory();
  updateHistoryDisplay();

  navigator.geolocation.getCurrentPosition(async (position) => {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    // Initialize the map with user's location
    initMap(lat, lon);

    document.getElementById("status").textContent = `Searching POIs near ${lat.toFixed(5)}, ${lon.toFixed(5)}...`;

    try {
      const pois = await fetchPOIs(lat, lon);
      document.getElementById("status").textContent = `Found ${pois.length} POIs:`;
      displayPOIs(pois);
    } catch (err) {
      showError(err);
    }
  }, showError, { enableHighAccuracy: true });
}

// Start the app
initApp();
</script>

</body>
</html>