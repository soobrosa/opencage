<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POI Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 1em; }
    h1 { font-size: 1.5em; }
    .container { display: flex; gap: 1em; flex-wrap: wrap; }
    #map { height: 400px; width: 100%; min-width: 300px; flex: 1; border: 1px solid #ccc; border-radius: 8px; }
    #sidebar { flex: 1; min-width: 300px; }
    #pois { margin-top: 1em; max-height: 350px; overflow-y: auto; }
    .poi { margin-bottom: 1em; padding: 0.5em; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
    .poi:hover { background-color: #f5f5f5; }
    button { margin-top: 0.5em; }
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      #map { height: 300px; }
    }
  </style>
</head>
<body>

<h1>Nearby POI Check-In</h1>
<p id="status">Getting your location...</p>

<div class="container">
  <div id="map"></div>
  <div id="sidebar">
    <div id="pois"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let userMarker;
let poiMarkers = [];
let userLocation = { lat: null, lon: null };

// Calculate distance between two points using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth's radius in kilometers
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c; // Distance in kilometers
  return Math.round(distance * 1000); // Return distance in meters
}

function initMap(lat, lon) {
  // Store user location for distance calculations
  userLocation.lat = lat;
  userLocation.lon = lon;
  
  map = L.map('map').setView([lat, lon], 16);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);
  
  // Add user location marker
  userMarker = L.marker([lat, lon], {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  
  userMarker.bindPopup("üìç Your Location").openPopup();
}

function addPOIToMap(poi, name, type) {
  const lat = poi.lat || poi.center?.lat;
  const lon = poi.lon || poi.center?.lon;
  
  if (!lat || !lon) return null;
  
  const marker = L.marker([lat, lon], {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  
  marker.bindPopup(`<strong>${name}</strong><br><em>${type}</em>`);
  poiMarkers.push(marker);
  
  return marker; // Return marker so we can reference it later
}

async function fetchPOIs(lat, lon) {
  const radius = 500; // meters
  const query = `
    [out:json];
    (
      node(around:${radius},${lat},${lon})["amenity"];
      way(around:${radius},${lat},${lon})["amenity"];
      relation(around:${radius},${lat},${lon})["amenity"];
    );
    out center;
  `;

  const response = await fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query,
  });

  const data = await response.json();
  return data.elements;
}

function displayPOIs(pois) {
  const container = document.getElementById("pois");
  container.innerHTML = "";

  // Clear existing POI markers
  poiMarkers.forEach(marker => map.removeLayer(marker));
  poiMarkers = [];

  if (pois.length === 0) {
    container.textContent = "No POIs found within 500m.";
    return;
  }

  const filteredPois = [];

  pois.forEach((poi, i) => {
    // Try multiple name sources from OpenStreetMap tags
    const name = poi.tags.name || 
                 poi.tags.brand || 
                 poi.tags.operator || 
                 poi.tags['addr:housename'] || 
                 poi.tags.official_name || 
                 poi.tags.alt_name ||
                 poi.tags.ref ||
                 null; // Don't fall back to amenity type
    
    // Only show POIs with proper names that start with a capital letter
    if (!name || !name.charAt(0).match(/[A-Z]/)) {
      return;
    }

    // Calculate distance from user location
    const poiLat = poi.lat || poi.center?.lat;
    const poiLon = poi.lon || poi.center?.lon;
    
    if (!poiLat || !poiLon) return;

    const distance = calculateDistance(userLocation.lat, userLocation.lon, poiLat, poiLon);
    
    filteredPois.push({
      ...poi,
      name: name,
      distance: distance
    });
  });

  // Sort POIs by distance (closest first)
  filteredPois.sort((a, b) => a.distance - b.distance);

  // Display sorted POIs
  filteredPois.forEach((poi, i) => {
    const type = poi.tags.amenity || "Unknown";
    const div = document.createElement("div");
    div.className = "poi";
    
    // Format distance display
    const distanceText = poi.distance < 1000 ? 
      `${poi.distance}m` : 
      `${(poi.distance / 1000).toFixed(1)}km`;
    
    div.innerHTML = `<strong>${poi.name}</strong><br><em>${type}</em><br><small>üìç ${distanceText} away ‚Ä¢ Click to view on map</small><br>`;
    
    const btn = document.createElement("button");
    btn.textContent = "Check In";
    btn.onclick = (e) => {
      e.stopPropagation(); // Prevent div click when button is clicked
      alert(`Checked in to: ${poi.name}`);
    };
    div.appendChild(btn);

    container.appendChild(div);

    // Add POI to map and get marker reference
    const marker = addPOIToMap(poi, poi.name, type);
    
    // Add click handler to POI div to zoom to location on map
    if (marker) {
      div.onclick = (e) => {
        // Don't trigger if button was clicked
        if (e.target.tagName === 'BUTTON') return;
        
        const poiLat = poi.lat || poi.center?.lat;
        const poiLon = poi.lon || poi.center?.lon;
        
        if (poiLat && poiLon) {
          // Zoom to POI location
          map.setView([poiLat, poiLon], 18);
          // Open the marker popup
          marker.openPopup();
        }
      };
    }
  });

  // Update status with filtered count
  const statusElement = document.getElementById("status");
  const originalText = statusElement.textContent;
  statusElement.textContent = originalText.replace(/Found \d+ POIs:/, `Found ${filteredPois.length} named POIs (${pois.length} total):`);
}

function showError(error) {
  document.getElementById("status").textContent = "Error: " + error.message;
}

navigator.geolocation.getCurrentPosition(async (position) => {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  // Initialize the map with user's location
  initMap(lat, lon);

  document.getElementById("status").textContent = `Searching POIs near ${lat.toFixed(5)}, ${lon.toFixed(5)}...`;

  try {
    const pois = await fetchPOIs(lat, lon);
    document.getElementById("status").textContent = `Found ${pois.length} POIs:`;
    displayPOIs(pois);
  } catch (err) {
    showError(err);
  }
}, showError, { enableHighAccuracy: true });
</script>

</body>
</html>